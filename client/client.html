<!DOCTYPE html>
<html lang="en">

<head>
  <title>Our simple HTTP server</title>
  <link rel="stylesheet" type="text/css" href="style.css">
  <style>

  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
  <script type="text/babel">

    var canvas, ctx, imgCanvas, imgCtx;

    var createdCards= [];
    var cardIndex = 0;
    const handleResponse = (xhr, parseResponse) => {
      const content = document.querySelector('#content');
      //const type = xhr.getResponseHeader('content-type');

      console.log(xhr.status);
      switch(xhr.status) {
        case 200: 
          content.innerHTML = `<b>Success </b>`;
          break;
        case 201: 
          content.innerHTML = `<b>User Created</b>`;
          break;
        case 204:
          
          content.innerHTML = '<b>Updated</b>';
          break;
        case 400:
          content.innerHTML = '<b>Bad Request</b>';
          break;
        case 403:
          content.innerHTML = '<b>Forbidden</b>';
        case 404: 
          content.innerHTML = `<b>Resource Not Found</b>`;
          break;
        default: 
          content.innerHTML = `<b>Resource Not Found</b>`;
          break;
      
        }
       
      
        
        if(parseResponse && xhr.response) {
   
          const obj = JSON.parse(xhr.response);
          
          console.dir(obj);
          if(obj.exportVal){
            if(obj.exportVal.length > 0){
             
              //content.innerHTML += `<br/> ${obj.exportVal[0].score}`;'<b>Updated</b>
              document.getElementById("votes").innerHTML = "<b>Votes: " + obj.exportVal[0].score +"</b>";
              createdCards= obj.exportVal;
              cardIndex = 0;
              drawFromServer(obj.exportVal[0]);
              console.dir(obj.exportVal[0]);
              document.getElementById('like').disabled = false;
              if(obj.exportVal.length > 1){
                
                document.getElementById('next').disabled = false;
                

              }
              else{
                document.getElementById('next').disabled = true;
                
              }

            }
            else{
              document.getElementById('like').disabled = true;
              ctx.clearRect(0, 0, canvas.width, canvas.height);
              imgCtx.clearRect(0, 0, canvas.width, canvas.height);

            }
            
          }
          else{
              content.innerHTML += `<br/>  ${obj.message}`;
            }
        }
        else {
          console.log('received');
        }


    };

   


    const requestUpdate = (e, userForm) => {
      
      
     
      
      const url = userForm.querySelector('#urlField').value;
      const method = userForm.querySelector('#methodSelect').value;
      
      const getClass = userForm.querySelector('#getClass').value;
      const getRarity = userForm.querySelector('#getRarityField').value;
      //console.log(getClass);
      const xhr = new XMLHttpRequest();
      const qs = {
        class:getClass,
        rarity: getRarity,

      };

      

      const query = Object.keys(qs).map(key => key + '='+ qs[key]).join('&');
      console.log(url +'?' +query);
      xhr.open(method, url +'?' +query);

      xhr.setRequestHeader('Accept', 'application/json');
      

      if(method === 'get'){
        xhr.onload = () => handleResponse(xhr, true);
      }
      else{
        xhr.onload = () => handleResponse(xhr, false);
      }
      
      //send ajax request
      xhr.send();
      
      //cancel browser's default action
      e.preventDefault();
      //return false to prevent page redirection from a form
      return false;


    };

    
    function like(){
      if(createdCards.length <= 0){
        return;
      }
      const nameField = createdCards[cardIndex].name;
      const voteField = 1;
      console.log(nameField);
      const xhr = new XMLHttpRequest();
      xhr.open('post', '/addCard');
      
      xhr.setRequestHeader('Accept', 'application/json');

      xhr.onload = () => handleResponse(xhr, true);
      
      const formData = `name=${nameField}&vote=1`;
      xhr.send(formData);
      return false;
    }

    const sendPost = (e, nameForm) => {
      
      imgCtx.drawImage(canvas, 0, 0);
      ctx.clearRect(0,0,canvas.width, canvas.height);
      
      imgCtx.clearRect(0,0,canvas.width, canvas.height );
      
      const nameAction = nameForm.getAttribute('action');
      const nameMethod = nameForm.getAttribute('method');

      const nameField = nameForm.querySelector('#nameField');
      const costField = nameForm.querySelector('#costField');
      const attackField = nameForm.querySelector('#attackField');
      const healthField = nameForm.querySelector('#healthField');
      const textField = nameForm.querySelector('#textField');
      var rarityImg = document.getElementById('rarityField');
      const rarityField = rarityImg.options[rarityImg.selectedIndex].text;
      var classImg = document.getElementById('classField');
      const classField = classImg.options[classImg.selectedIndex].text;
      
      var cardArt = document.getElementById('artField');
      const artField = cardArt.options[cardArt.selectedIndex].text;

      //Stream Image
      //const cardField = convertToImage();
    
      const xhr = new XMLHttpRequest();
      xhr.open(nameMethod, nameAction);
      
      xhr.setRequestHeader('Accept', 'application/json');

      xhr.onload = () => handleResponse(xhr, true);

      const formData = `name=${nameField.value}&cost=${costField.value}&attack=${attackField.value}&health=${healthField.value}&text=${textField.value}&rarity=${rarityField}&class=${classField}&cardArt=${artField}`;
    
    
      xhr.send(formData);
      


      e.preventDefault();
      return false;
      
    };


    function drawFromServer(card){
      var cardClass;
      var gemClass;
      var classImg = document.getElementById('classField');
      var rarityImg = document.getElementById('rarityField');
      var cardArt = document.getElementById('artField');
      for(var i = 0; i < classImg.length; i++){
        if(classImg[i].text == card.class){
          cardClass = classImg[i].value;

        }
        
      }
      for(var i = 0; i < rarityImg.length; i++){
        if(rarityImg[i].text == card.rarity){
          gemClass = rarityImg[i].value;
        }
      }
      

      setBackground(cardClass, gemClass, card);
      
      for(var i = 0; i <cardArt.length; i++){
        if(cardArt[i].text == card.cardArt){
          readPic(cardArt[i].value);
        }
      }
    }

    function updateCardServer(card){
      updateFromServer("setName", card.name, 200, 300);
    
      updateFromServer("setAttack", card.attack, 50, 490);

      updateFromServer("setHealth", card.health, 345, 490);
  
      updateFromServer("setText", card.text, 200, 430);

      updateFromServer("setCost", card.cost, 50, 50);
    }

    function updateFromServer(location, value, x, y){
      ctx.font = "30px Arial";
      ctx.textAlign="center";    
      ctx.fillText(value,x,y);
      
    }

    const init = () => {
   


      canvas = document.querySelector('#canvas');
      ctx = canvas.getContext('2d');
      imgCanvas = document.querySelector('#imageCanvas');
      imgCtx = imgCanvas.getContext('2d');
      //Post Instructions
      const nameForm = document.querySelector('#nameForm');
      const addUser = (e) => sendPost(e, nameForm);
      document.getElementById('createCardButton').addEventListener('click', addUser);

      //GET intructions
      const userForm = document.querySelector('#userForm');
      const getUsers = (e) => requestUpdate(e, userForm);
      userForm.addEventListener('submit', getUsers);

    var classImg = document.getElementById('classField');
    var rarityImg = document.getElementById('rarityField');

      rarityImg.onchange = function(){
        //console.log( rarityImg.options[rarityImg.selectedIndex].text);
        setGem(rarityImg.value);
      }

    classImg.onchange = function(){

      setBackground(classImg.value, rarityImg.value);  
    }
    
    document.getElementById('makeCard').onclick = function(){
      document.getElementById('nameForm').style.display = "block";
      document.getElementById('userForm').style.display = "none";
      document.getElementById('votes').style.display = "none";
      document.getElementById('like').style.display = "none";
      document.getElementById('next').style.display = 'none';
      document.getElementById('previous').style.display = 'none';
      
    }

    document.getElementById('viewCard').onclick = function(){
      document.getElementById('nameForm').style.display = "none";
      document.getElementById('userForm').style.display = "block";
      document.getElementById('like').style.display = "block";
      document.getElementById('next').style.display = 'inline';
      document.getElementById('previous').style.display = 'inline';
      document.getElementById('votes').style.display = "block";


    }

    document.getElementById('nameField').onchange = function(){
      setBackground(classImg.value, rarityImg.value);
    }
    document.getElementById('attackField').onchange = function(){    
      setBackground(classImg.value, rarityImg.value);
    }
    document.getElementById('healthField').onchange = function(){
      setBackground(classImg.value, rarityImg.value);
    }
    document.getElementById('textField').onchange = function(){
      setBackground(classImg.value, rarityImg.value);
    }
    document.getElementById('costField').onchange = function(){
      setBackground(classImg.value, rarityImg.value);        
    }
    document.getElementById('artField').onchange = function(){
      readPic(document.getElementById('artField').value);        
    }
      
      document.getElementById('next').onclick = function(){
        cardIndex++;
        drawFromServer(createdCards[cardIndex]);
        document.getElementById("votes").innerHTML = "Votes: " + createdCards[cardIndex].score;
        if(cardIndex == createdCards.length-1){
          document.getElementById('next').disabled = true;
        }
        document.getElementById('previous').disabled = false;
      }

      document.getElementById('previous').onclick = function(){
      
        cardIndex--;
        drawFromServer(createdCards[cardIndex]);
        if(cardIndex == 0){
          document.getElementById('previous').disabled = true;
        }
        document.getElementById('next').disabled = false;
      }

      document.getElementById('like').onclick = like;

      //Disable the buttons untill we get cards from the server
      document.getElementById('next').disabled = true;
      document.getElementById('previous').disabled = true;
      document.getElementById('like').disabled = true;

      setBackground(classImg.value, rarityImg.value);
    
    };


    function setBackground(url, gemUrl, fromServer){
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      var img = new Image();
      img.onload = function(){
        console.log(img.width + "   " + img.height);
        ctx.drawImage(img, -10, 0);
        setGem(gemUrl); 
        if(fromServer){
          updateCardServer(fromServer);
        }
        else{
          updateText();
        }
      }
      img.src = url;

    }

    function setGem(url){
      var img = new Image();
      img.onload = function(){
        
        ctx.drawImage(img, canvas.width/2 -14, canvas.height/2+30);

      
      }
      img.src = url;

    }
    

    function updateText(){

      
      updateField("setName", "nameField", 200, 300);
    
      updateField("setAttack", "attackField", 50, 490);
   
      updateField("setHealth", "healthField", 345, 490);
  
      updateField("setText", "textField", 200, 430);

      updateField("setCost", "costField", 50, 50);
    }

 
    function updateField(location, value, x, y){
      var textVal = document.getElementById(value).value;
      //document.getElementById(location).innerHTML = textVal;
      ctx.font = "30px Arial";
      ctx.textAlign="center";    
      ctx.fillText(textVal,x,y);
      
    }

    function  readPic(url) {
      imgCtx.clearRect(0,0, imgCanvas.width,imgCanvas.height);
      if(url === ""){
        return;
      }
     
      var img = new Image();
          
      img.onload = function(){
        var ratio = img.height/img.width;
        imgCtx.globalCompositeOperation = 'destination-over';
        imgCtx.drawImage(img, 80, 40, 240,250);
        imgCtx.globalCompositeOperation = 'source-over';
        }
      img.src =url;
      
    }

    window.onload = init;

  </script>
</head>

<body>
  <section id="top">
    <h2>Hearthstone Card Creator</h2>

    <div class="tab">
      <button id="makeCard">Create Card</button>
      <button id="viewCard">View Cards</button>
    </div>
    <form id="nameForm" action="/addCard" method="post" class="cardBuilder">
      <label for="name">Card Name: </label>
      <input id="nameField" type="text" name="name" value="tempname" required />
      <label for="attack">Attack: </label>
      <input id="attackField" type="number" name="attack" min="0" max="100" step="1" value="1" required />
      <label for="health">Health: </label>
      <input id="healthField" type="number" name="health" min="0" max="100" step="1" value="1" required />
      <label for="cost">Cost: </label>
      <input id="costField" type="number" name="cost" min="0" max="100" step="1" value="1" required />
      <label for="cardText">Card Text: </label>
      <input id="textField" type="text" name="cardText" value="1" required />
      <label for="class">Class: </label>

      <select id="classField" name="class">
        <option value="Images/card_minion_neutral.png">Neutral</option>
        <option value="Images/card_minion_mage.png">Mage</option>
        <option value="Images/card_minion_warrior.png">Warrior</option>
        <option value="Images/card_minion_hunter.png">Hunter</option>
        <option value="Images/card_minion_druid.png">Druid</option>
        <option value="Images/card_minion_priest.png">Preist</option>
        <option value="Images/card_minion_paladin.png">Paladin</option>
        <option value="Images/card_minion_shaman.png">Shaman</option>
        <option value="Images/card_minion_warlock.png">Warlock</option>
        <option value="Images/card_minion_rogue.png">Rouge</option>

      </select>

      <label for="rarity">Rarity: </label>
      <select id="rarityField" name='rarity'>
        <option value="">Classic</option>
        <option value="Images/gem_common.png">Common</option>
        <option value="Images/gem_rare.png">Rare</option>
        <option value="Images/gem_epic.png">Epic</option>
        <option value="Images/gem_legendary.png">Legendary</option>
      </select>
      <label for="art">Card Art: </label>
      <select id="artField" name="art">
        <option value="">None</option>
        <option value="Images/CardArt1.jpg">1</option>
        <option value="Images/CardArt2.jpg">2</option>
        <option value="Images/CardArt3.jpg">3</option>
        <option value="Images/CardArt4.jpg">4</option>
        <option value="Images/CardArt5.jpg">5</option>
        <option value="Images/CardArt6.jpg">6</option>
        <option value="Images/CardArt7.jpg">7</option>
        <option value="Images/CardArt8.jpg">8</option>
        <option value="Images/CardArt9.jpg">9</option>
        <option value="Images/CardArt10.jpg">10</option>
      </select>



      <input type="button" id='createCardButton' value="AddCard" />
    </form>
    <form id="userForm" action="/getUsers" method="get" class="cardViewer">
      <select id='urlField'>
        <option value='/getUsers'>/getUsers</option>
        <option value='/notReal'>/notReal</option>
      </select>
      <select id="methodSelect">
        <option value="get">GET</option>
        <option value="head">HEAD</option>
      </select>
      <label for="getClass">Get cards of class: </label>
      <select id="getClass" name="getClass">
        <option value="All">All</option>
        <option value="Neutral">Neutral</option>
        <option value="Mage">Mage</option>
        <option value="Warrior">Warrior</option>
        <option value="Hunter">Hunter</option>
        <option value="Druid">Druid</option>
        <option value="Preist">Preist</option>
        <option value="Paladin">Paladin</option>
        <option value="Shaman">Shaman</option>
        <option value="Warlock">Warlock</option>
        <option value="Rouge">Rouge</option>

      </select>

      <label for="getRarity">Get cards of Rarity: </label>
      <select id="getRarityField" name='getRarity'>
        <option value="All">All</option>
        <option value="Classic">Classic</option>
        <option value="Common">Common</option>
        <option value="Rare">Rare</option>
        <option value="Epic">Epic</option>
        <option value="Legendary">Legendary</option>
      </select>

      <input type="submit" id='getUser' value="Get User" />
    </form>


  </section>
  <div id="cardView">
    <button id="previous">Previous Card</button>
    <button id="next">Next Card</button>

    <button id="like">Like</button>
    <div id="wrapper">
      <canvas id="imageCanvas" width="400" height="543"></canvas>
      <canvas id="canvas" width="400" height="543"></canvas>

    </div>
    <p id="votes"></p>
    <p id="content"></p>
  </div>
</body>

</html>